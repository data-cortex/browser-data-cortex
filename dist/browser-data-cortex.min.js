!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).DataCortex={})}(this,function(e){"use strict";const n=["kingdom","phylum","class","order","family","genus","species","spend_currency","spend_type","network","channel"],t=["group_tag","from_tag"],o=["float1","float2","float3","float4","spend_amount"],i=["repsonse_bytes","response_ms"],r={hostname:64,filename:256,log_level:64,device_tag:62,user_tag:62,remote_address:64,log_line:65535},l="https://api.data-cortex.com",s=[...n,...t,...o,"type","event_index","event_datetime","to_list"],a=[...i,...Object.keys(r),"event_datetime"];let c=l,u=!1,d=!1,f=null,g=null,_=null,p="0",v=null,m=[],w=!1,y=0,h=null,b=null,S=0,k=null,E=!1,x=0,O=0,j=null,T=null,A=0;const P={};let C=[],D=function(...e){console.error("Data Cortex Error:",...e)};function F(...e){D(...e)}function I(e){let n;if(e in window.localStorage){const t=window.localStorage[e];try{n=JSON.parse(t)}catch(e){}}return n}function M(e,n){const t=JSON.stringify(n);window.localStorage[e]=t}function B(){let e="";const n=new Uint32Array(8);window.crypto.getRandomValues(n);for(const t of n)e+=t.toString(36);return e=e.slice(0,32),e}function $(e){var n,t,o,i,r,s,a,d,f,k;const E=null!==(t=null!==(n=e.base_url)&&void 0!==n?n:I("dc.base_url"))&&void 0!==t?t:l;c="string"==typeof E?E:l,g=e.api_key,_=e.org_name,p=null!==(o=e.app_ver)&&void 0!==o?o:"0",v=null!==(i=I("dc.user_tag"))&&void 0!==i?i:null,e.errorLog&&"function"==typeof e.errorLog&&(D=e.errorLog),m=null!==(r=I("dc.event_list"))&&void 0!==r?r:[],S=null!==(s=I("dc.next_index"))&&void 0!==s?s:0;for(const e of m)e.event_index&&e.event_index>=S&&(S=e.event_index+1);C=null!==(a=I("dc.log_list"))&&void 0!==a?a:[],y=null!==(d=I("dc.last_dau_time"))&&void 0!==d?d:0,w=null!==(f=I("dc.has_sent_install"))&&void 0!==f&&f||Boolean(y),e.device_tag?(b=e.device_tag,M("dc.device_tag",e.device_tag)):b=function(){var e;let n=null!==(e=I("dc.device_tag"))&&void 0!==e?e:null;return n||(n=B(),M("dc.device_tag",n)),n}(),null!=h||(h=B()),w||(w=!0,M("dc.has_sent_install",!0),z({type:"install",kingdom:"organic",phylum:"organic",class:"organic",order:"organic",family:"organic",genus:"organic",species:"organic"})),W(),window.setInterval(W,432e5),function(){function e(e,n,t){let o=t;const i=e.match(n);return i&&i.length>1&&void 0!==i[1]&&(o=i[1]),o}const n=navigator.userAgent;let t="unknown",o="unknown";n.includes("Win")?(t="windows",o=e(n,/Windows NT ([^ ;)]*)/,"unknown")):n.includes("iPhone OS")?(t="ios",o=e(n,/iPhone OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):n.includes("iPad")?(t="ios",o=e(n,/CPU OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):n.includes("Mac OS X")?(t="mac",o=e(n,/Mac OS X ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,"."),o=o.replace(/\.0$/,"")):n.includes("Android")?(t="android",o=e(n,/Android ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):n.includes("X11")?t="unix":n.includes("Linux")&&(t="linux");let i="unknown",r="unknown";n.includes("Edg/")?(i="edge",r=e(n,/Edg\/([^ ;)]*)/,"unknown")):n.includes("Edge")?(i="edge",r=e(n,/Edge\/([^ ;)]*)/,"unknown")):n.includes("Chrome")?(i="chrome",r=e(n,/Chrome\/([^ ;)]*)/,"unknown")):n.includes("CriOS")?(i="chrome",r=e(n,/CriOS\/([^ ;)]*)/,"unknown")):n.includes("Firefox")?(i="firefox",r=e(n,/Firefox\/([^ ;)]*)/,"unknown")):n.includes("Android")?(i="android",r=e(n,/Version\/([^ ;)]*)/,"unknown")):n.includes("Safari")?(i="safari",r=e(n,/Version\/([^ ;)]*)/,"unknown")):n.includes("Trident")?(i="ie",r=e(n,/rv:([^ ;)]*)/,"unknown")):n.includes("MSIE")?(i="ie",r=e(n,/MSIE ([^ ;)]*)/,"unknown")):(n.includes("MessengerForiOS")||n.includes("FB_IAB/MESSENGER"))&&(i="fbmessenger",r=e(n,/FBAV\/([^ ;)]*)/,"unknown"));let l="desktop";n.includes("iPod")?l="ipod":n.includes("iPhone")?l="iphone":n.includes("iPad")?l="ipad":n.includes("Android")?l=n.includes("Mobile")?"android":"android_tablet":n.includes("Mobile")&&(l="mobile");P.os=t,P.os_ver=o,P.browser=i,P.browser_ver=r,P.device_type=l,P.device_family=l}(),u=!0,H(),null!==(k=e.add_error_handler)&&void 0!==k&&k&&window.addEventListener("error",q)}function q(e){K("Javascript Error:",e)}function N(){return u}function J(){return b}function L(e){var n;v=e?String(e):null,v?M("dc.user_tag",v):(n="dc.user_tag",delete window.localStorage[n])}function R(e){if("object"!=typeof e||null===e)throw new Error("props must be an object");z(Object.assign({},e,{type:"event"}))}function U(e){if("object"!=typeof e||null===e)throw new Error("props must be an object");if(!e.spend_currency)throw new Error("spend_currency is required");if("number"!=typeof e.spend_amount)throw new Error("spend_amount is required");z(Object.assign({},e,{type:"economy"}))}function V(e){var n;if("object"!=typeof e||null===e)throw new Error("props must be an object");if(!e.from_tag)throw new Error("from_tag is required");if(!e.to_tag&&!e.to_list)throw new Error("to_tag or to_list is required");if(e.to_list&&!Array.isArray(e.to_list))throw new Error("to_list must be an array.");if(null!==(n=e.to_list)&&void 0!==n||(e.to_list=[]),e.to_tag&&e.to_list.push(e.to_tag),0===e.to_list.length)throw new Error("must have at least 1 in to_list or a to_tag");z(Object.assign({},e,{type:"message_send"}))}function X(e){var n;if("object"!=typeof e||null===e)throw new Error("props must be an object.");null!==(n=e.event_datetime)&&void 0!==n||(e.event_datetime=(new Date).toISOString());for(const n in r)if(n in e){const t=r[n],o=e[n];e[n]=null!=o?String(o).slice(0,t):void 0}for(const n of i)if(n in e){let t=e[n];"number"!=typeof t&&(t=parseFloat(String(t))),"number"==typeof t&&isFinite(t)?e[n]=t:e[n]=void 0}const t={};for(const n of a)n in e&&(t[n]=e[n]);C.push(t),M("dc.log_list",C),ee(0)}function K(...e){if(0===e.length)throw new Error("log must have arguments");let n="";for(let t=0;t<e.length;t++){const o=e[t];if(t>0&&(n+=" "),Z(o))n+=`${o.message} ${o.stack}`;else if("object"==typeof o)try{n+=JSON.stringify(o)}catch(e){n+=String(o)}else n+=String(o)}X({log_line:n})}function W(){Date.now()-y>864e5&&(z({type:"dau"}),y=Date.now(),M("dc.last_dau_time",y))}function G(e,n){let t;return"string"==typeof e?t=e:null!=e&&(t=String(e)),t&&t.length>0&&(t=t.slice(0,n)),t}function z(e){var i;e.event_index=S++,null!==(i=e.event_datetime)&&void 0!==i||(e.event_datetime=(new Date).toISOString()),h&&(e.group_tag=h);for(const t of n)if(t in e){const n=e[t];e[t]=G(n,32)}for(const n of t)if(n in e){const t=e[n];e[n]=G(t,64)}for(const n of o)if(n in e){let t=e[n];"number"!=typeof t&&(t=parseFloat(String(t))),"number"==typeof t&&isFinite(t)?e[n]=t:e[n]=void 0}for(const n in e)s.includes(n)||(e[n]=void 0);m.push(e),M("dc.event_list",m),H()}function H(e){f||!u||d||(f=setTimeout(()=>{f=null,Q()},null!=e?e:0))}function Q(){if(u&&!d&&m.length>0){d=!0;const e=Object.assign({},P,{api_key:g,app_ver:p,device_tag:b});let n;v&&(e.user_tag=v),e.events=[];for(const t of m)n?n.session_key===t.session_key&&e.events.push(t):(n=t,e.events.push(t));e.events.splice(10);const t=encodeURIComponent((new Date).toISOString());Y({url:`${c}/${_}/1/track?current_time=${t}`,method:"POST",body:e},(n,t,o)=>{let i=!0;var r;"status"===n?400===t?F("Bad request, please check parameters, error:",o):403===t?(F("Bad API Key, error:",o),u=!1):409===t||(i=!1,A++):n?(i=!1,A++):A=0,i&&(r=e.events,m=m.filter(e=>!r.some(n=>e.event_index===n.event_index)),M("dc.event_list",m),M("dc.next_index",S)),d=!1,m.length>0&&H(2e3*A)})}}function Y(e,n){O++;let t=!1;function o(...e){t||(t=!0,n(...e),O--,T&&0===O&&(T(),j=null,T=null))}const{method:i}=e,r={Accept:"application/json"},{body:l}=e;let s=null;l instanceof FormData?s=l:l&&(s=JSON.stringify(l),r["Content-Type"]="text/plain");const a=Object.assign({},r,e.headers),{url:c}=e,u={method:i,headers:a,body:s};let d;if(e.timeout){const n=new AbortController;u.signal=n.signal,d=setTimeout(()=>{n.abort()},e.timeout)}fetch(c,u).then(async e=>{d&&clearTimeout(d);const{status:n}=e;let t="";try{t=await e.text()}catch(e){}let i=null;n<200||n>599?i="wierd_status":n>=300&&(i="status"),o(i,n,t)}).catch(e=>{d&&clearTimeout(d),"AbortError"===e.name?o("timeout"):o("fetch_error")})}function Z(e){return"object"==typeof e&&null!==e&&"stack"in e&&"message"in e&&"string"==typeof e.stack&&"string"==typeof e.message}function ee(e){k||!u||E||(k=setTimeout(()=>{k=null,ne()},e))}function ne(){if(u&&!E&&C.length>0){E=!0;const e=Object.assign({},P,{api_key:g,app_ver:p,device_tag:b});v&&(e.user_tag=v),e.events=C.slice(0,10);Y({url:`${c}/${_}/1/app_log`,method:"POST",body:e},(n,t,o)=>{let i=!0;var r;"status"===n?400===t?F("Bad request, please check parameters, error:",o):403===t?F("Bad API Key, error:",o):409===t||(i=!1,x++):n?(i=!1,x++):x=0,i&&e.events&&(r=e.events,C.splice(0,r.length),M("dc.log_list",C)),E=!1,C.length>0&&ee(2e3*x)})}}function te(){return j||(u?(f&&(clearTimeout(f),f=null),k&&(clearTimeout(k),k=null),m.length>0&&!d&&Q(),C.length>0&&!E&&ne(),O>0?(j=new Promise(e=>{T=e}),j):Promise.resolve()):(F("DataCortex not ready. Call init() first."),Promise.resolve()))}function oe(){f&&(clearTimeout(f),f=null),k&&(clearTimeout(k),k=null),u=!1,d=!1,E=!1,m=[],C=[],O=0,T&&(T(),j=null,T=null)}const ie={init:$,isReady:N,getDeviceTag:J,addUserTag:L,event:R,economyEvent:U,messageSendEvent:V,log:K,logEvent:X,flush:te,destroy:oe};"undefined"!=typeof window&&(window.DataCortex=ie),e.addUserTag=L,e.default=ie,e.destroy=oe,e.economyEvent=U,e.event=R,e.flush=te,e.getDeviceTag=J,e.init=$,e.isReady=N,e.log=K,e.logEvent=X,e.messageSendEvent=V,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=browser-data-cortex.min.js.map
