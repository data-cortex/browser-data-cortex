!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DataCortex={})}(this,function(e){"use strict";const t=["kingdom","phylum","class","order","family","genus","species","spend_currency","spend_type","network","channel"],n=["group_tag","from_tag"],o=["float1","float2","float3","float4","spend_amount"],i=["repsonse_bytes","response_ms"],r={hostname:64,filename:256,log_level:64,device_tag:62,user_tag:62,remote_address:64,log_line:65535},s="https://api.data-cortex.com",a=[...t,...n,...o,"type","event_index","event_datetime","to_list"],l=[...i,...Object.keys(r),"event_datetime"];let d=s,c=!1,u=!1,f=null,g=!1,_=!1,p="0",m=null,v=[],h=!1,w=0,y=!1,x=0,b=null,O=!1,S=0,k=0;const E={};let T=[],j=function(...e){console.error("Data Cortex Error:",...e)};function A(...e){j(...e)}function C(e){let t;if(e in window.localStorage){const n=window.localStorage[e];try{t=JSON.parse(n)}catch(e){}}return t}function D(e,t){const n=JSON.stringify(t);window.localStorage[e]=n}function P(){var e;let t=null!==(e=C("dc.device_tag"))&&void 0!==e&&e;return t||(t=function(){var e;let t="";if(null===(e=window.crypto)||void 0===e?void 0:e.getRandomValues){const e=new Uint32Array(8);window.crypto.getRandomValues(e);for(let n=0;n<e.length;n++)t+=e[n].toString(36)}else for(;t.length<32;)t+=Math.random().toString(36).slice(2);return t=t.slice(0,32),t}(),D("dc.device_tag",t)),t}function F(e){var t,n,o,i,r,a,l,u,f;const b=null!==(n=null!==(t=e.base_url)&&void 0!==t?t:C("dc.base_url"))&&void 0!==n?n:s;d="string"==typeof b?b:s,g=e.api_key,_=e.org_name,p=null!==(o=e.app_ver)&&void 0!==o?o:"0",m=null!==(i=C("dc.user_tag"))&&void 0!==i?i:null,e.errorLog&&"function"==typeof e.errorLog&&(j=e.errorLog),v=null!==(r=C("dc.event_list"))&&void 0!==r?r:[],x=null!==(a=C("dc.next_index"))&&void 0!==a?a:0,v.forEach(e=>{e.event_index>=x&&(x=e.event_index+1)}),T=null!==(l=C("dc.log_list"))&&void 0!==l?l:[],w=null!==(u=C("dc.last_dau_time"))&&void 0!==u?u:0,h=null!==(f=C("dc.has_sent_install"))&&void 0!==f&&f||Boolean(w),e.device_tag?(y=e.device_tag,D("dc.device_tag",e.device_tag)):y=P(),h||(h=!0,D("dc.has_sent_install",!0),L({type:"install",kingdom:"organic",phylum:"organic",class:"organic",order:"organic",family:"organic",genus:"organic",species:"organic"})),J(),setInterval(J,432e5),function(){function e(e,t,n){let o=n;const i=e.match(t);return i&&i.length>1&&(o=i[1]),o}const t=navigator.userAgent;let n="unknown",o="unknown";-1!==t.indexOf("Win")?(n="windows",o=e(t,/Windows NT ([^ ;)]*)/,"unknown")):-1!==t.indexOf("iPhone OS")?(n="ios",o=e(t,/iPhone OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("iPad")?(n="ios",o=e(t,/CPU OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("Mac OS X")?(n="mac",o=e(t,/Mac OS X ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,"."),o=o.replace(/\.0$/,"")):-1!==t.indexOf("Android")?(n="android",o=e(t,/Android ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("X11")?n="unix":-1!==t.indexOf("Linux")&&(n="linux");let i="unknown",r="unknown";-1!==t.indexOf("Edge")?(i="edge",r=e(t,/Edge\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Chrome")?(i="chrome",r=e(t,/Chrome\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("CriOS")?(i="chrome",r=e(t,/CriOS\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Firefox")?(i="firefox",r=e(t,/Firefox\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Android")?(i="android",r=e(t,/Version\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Safari")?(i="safari",r=e(t,/Version\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Trident")?(i="ie",r=e(t,/rv:([^ ;)]*)/,"unknown")):-1!==t.indexOf("MSIE")?(i="ie",r=e(t,/MSIE ([^ ;)]*)/,"unknown")):(-1!==t.indexOf("MessengerForiOS")||-1!==t.indexOf("FB_IAB/MESSENGER"))&&(i="fbmessenger",r=e(t,/FBAV\/([^ ;)]*)/,"unknown"));let s="desktop";-1!==t.indexOf("iPod")?s="ipod":-1!==t.indexOf("iPhone")?s="iphone":-1!==t.indexOf("iPad")?s="ipad":-1!==t.indexOf("Android")?s=-1===t.indexOf("Mobile")?"android_tablet":"android":-1!==t.indexOf("Mobile")&&(s="mobile");E.os=n,E.os_ver=o,E.browser=i,E.browser_ver=r,E.device_type=s,E.device_family=s}(),c=!0,U(),e.add_error_handler&&window.addEventListener("error",I)}function I(e){e&&K("Javascript Error: message:",e.message,"error:",e.error)}function M(){return c}function B(){return y}function q(e){var t;m=e?String(e):null,m?D("dc.user_tag",m):(t="dc.user_tag",delete window.localStorage[t])}function N(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");e.type="event",L(e)}function R(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");if(!e.spend_currency)throw new Error("spend_currency is required");if("number"!=typeof e.spend_amount)throw new Error("spend_amount is required");e.type="economy",L(e)}function $(e){var t;if(!e||"object"!=typeof e)throw new Error("props must be an object");if(!e.from_tag)throw new Error("from_tag is required");if(!e.to_tag&&!e.to_list)throw new Error("to_tag or to_list is required");if(e.to_list&&!Array.isArray(e.to_list))throw new Error("to_list must be an array.");if(null!==(t=e.to_list)&&void 0!==t||(e.to_list=[]),e.to_tag&&e.to_list.push(e.to_tag),0===e.to_list.length)throw new Error("must have at least 1 in to_list or a to_tag");e.type="message_send",L(e)}function J(){Date.now()-w>864e5&&(L({type:"dau"}),w=Date.now(),D("dc.last_dau_time",w))}function L(e){e.event_index=x++,e.event_datetime||(e.event_datetime=(new Date).toISOString()),t.forEach(t=>{if(t in e){const n=e[t],o=n?String(n):"";o?e[t]=o.slice(0,32):delete e[t]}}),n.forEach(t=>{if(t in e){const n=e[t],o=n?String(n):"";o?e[t]=o.slice(0,64):delete e[t]}}),o.forEach(t=>{if(t in e){let n=e[t];"number"!=typeof n&&(n=parseFloat(n)),isFinite(n)?e[t]=n:delete e[t]}});const i={};for(let t=0;t<a.length;t++){const n=a[t];n in e&&(i[n]=e[n])}v.push(i),D("dc.event_list",v),U()}function U(e){f||!c||u||(f=setTimeout(()=>{f=null,V()},null!=e?e:0))}function V(){if(c&&!u&&v.length>0){u=!0;const e=Object.assign({},E,{api_key:g,app_ver:p,device_tag:y});m&&(e.user_tag=m),e.events=[];let t=!1;v.some(n=>(t?t.session_key===n.session_key&&e.events.push(n):(t=n,e.events.push(n)),e.events.length<10));const n=encodeURIComponent((new Date).toISOString());X({url:`${d}/${_}/1/track?current_time=${n}`,method:"POST",body:e},(t,n,o)=>{let i=!0;var r;"status"===t?400===n?A("Bad request, please check parameters, error:",o):403===n?(A("Bad API Key, error:",o),c=!1):409===n||(i=!1,k++):t?(i=!1,k++):k=0,i&&(r=e.events,v=v.filter(e=>!r.some(t=>e.event_index===t.event_index)),D("dc.event_list",v),D("dc.next_index",x)),u=!1,v.length>0&&U(2e3*k)})}}function X(e,t){let n=!1;function o(...e){n||(n=!0,t(...e))}const i=e.method,r={Accept:"application/json"};let s=null;e.body instanceof FormData?s=e.body:e.body&&(s=JSON.stringify(e.body),r["Content-Type"]="text/plain");const a=Object.assign({},r,e.headers),l=e.url,d={method:i,headers:a};let c;if(s&&(d.body=s),e.timeout){const t=new AbortController;d.signal=t.signal,c=setTimeout(()=>{t.abort()},e.timeout)}fetch(l,d).then(async e=>{c&&clearTimeout(c);const t=e.status;let n="";try{n=await e.text()}catch(e){}let i=null;t<200||t>599?i="wierd_status":t>=300&&(i="status"),o(i,t,n)}).catch(e=>{c&&clearTimeout(c),"AbortError"===e.name?o("timeout"):o("fetch_error")})}function K(...e){if(!e||0===e.length)throw new Error("log must have arguments");let t="";for(let n=0;n<e.length;n++){const o=e[n];if(n>0&&(t+=" "),G(o))t+=o.stack;else if("object"==typeof o)try{t+=JSON.stringify(o)}catch(e){t+=o}else t+=o}W({log_line:t})}function W(e){var t;if(!e||"object"!=typeof e)throw new Error("props must be an object.");null!==(t=e.event_datetime)&&void 0!==t||(e.event_datetime=(new Date).toISOString());for(const t in r)if(t in e){const n=r[t],o=e[t];e[t]=null!=o?String(o).slice(0,n):void 0}i.forEach(t=>{if(t in e){let n=e[t];"number"!=typeof n&&(n=parseFloat(n)),isFinite(n)?e[t]=n:delete e[t]}});const n={};for(let t=0;t<l.length;t++){const o=l[t];o in e&&(n[o]=e[o])}T.push(n),D("dc.log_list",T),z()}function G(e){return"object"==typeof e&&null!==e&&"stack"in e&&"message"in e&&"string"==typeof e.stack&&"string"==typeof e.message}function z(e=0){b||!c||O||(b=setTimeout(()=>{b=null,H()},e))}function H(){if(c&&!O&&T.length>0){O=!0;const e=Object.assign({},E,{api_key:g,app_ver:p,device_tag:y});m&&(e.user_tag=m),e.events=T.slice(0,10);X({url:`${d}/${_}/1/app_log`,method:"POST",body:e},(t,n,o)=>{let i=!0;var r;"status"===t?400===n?A("Bad request, please check parameters, error:",o):403===n?A("Bad API Key, error:",o):409===n||(i=!1,S++):t?(i=!1,S++):S=0,i&&(r=e.events,T.splice(0,r.length),D("dc.log_list",T)),O=!1,T.length>0&&z(2e3*S)})}}function Q(){c?(f&&(clearTimeout(f),f=null),b&&(clearTimeout(b),b=null),v.length>0&&!u&&V(),T.length>0&&!O&&H()):A("DataCortex not ready. Call init() first.")}const Y={init:F,isReady:M,getDeviceTag:B,addUserTag:q,event:N,economyEvent:R,messageSendEvent:$,log:K,logEvent:W,flush:Q};"undefined"!=typeof window&&(window.DataCortex=Y),e.addUserTag=q,e.default=Y,e.economyEvent=R,e.event=N,e.flush=Q,e.getDeviceTag=B,e.init=F,e.isReady=M,e.log=K,e.logEvent=W,e.messageSendEvent=$,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=browser-data-cortex.min.js.map
