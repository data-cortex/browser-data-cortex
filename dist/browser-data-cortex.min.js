!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).DataCortex=t()}(this,function(){"use strict";const e=["kingdom","phylum","class","order","family","genus","species","spend_currency","spend_type","network","channel"],t=["group_tag","from_tag"],n=["float1","float2","float3","float4","spend_amount"],o=H(e,t,n,["type","event_index","event_datetime","to_list"]),r="https://api.data-cortex.com";let i=r,s=!1,a=!1,c=!1,d=!1,l=!1,u="0",f=!1,g=[],_=!1,p=0,w=!1,m=!1,h=0,y=0;const v={};let x=[],O=function(...e){console.error("Data Cortex Error:",...e)};function b(...e){O(...e)}function S(e){e&&F("Javascript Error: message:",e.message,"error:",e.error)}function k(e,t){let n;if(e in window.localStorage){const t=window.localStorage[e];try{n=JSON.parse(t)}catch(e){}}return void 0===n&&(n="function"==typeof t?t():t),n}function E(e,t){const n=JSON.stringify(t);window.localStorage[e]=n}function j(){let e="";const t=window.crypto||window.msCrypto;if(t&&t.getRandomValues){const n=new Uint32Array(8);t.getRandomValues(n);for(let t=0;t<n.length;t++)e+=n[t].toString(36)}else for(;e.length<32;)e+=Math.random().toString(36).slice(2);return e=e.slice(0,32),e}function A(){Date.now()-p>864e5&&(T({type:"dau"}),p=Date.now(),E("dc.last_dau_time",p))}function T(r){r.event_index=h++,r.event_datetime||(r.event_datetime=(new Date).toISOString()),w&&(r.group_tag=w),e.forEach(e=>{if(e in r){const t=r[e],n=t&&String(t);n?r[e]=n.slice(0,32):delete r[e]}}),t.forEach(e=>{if(e in r){const t=r[e],n=t&&String(t);n?r[e]=n.slice(0,64):delete r[e]}}),n.forEach(e=>{if(e in r){let t=r[e];"number"!=typeof t&&(t=parseFloat(t)),isFinite(t)?r[e]=t:delete r[e]}});const i=X(r,o);return g.push(i),E("dc.event_list",g),C(),i}function C(e){c||!s||a||(c=window.setTimeout(()=>{c=!1,D()},e||0))}function D(){if(s&&!a&&g.length>0){a=!0;const e=Object.assign({},v,{api_key:d,app_ver:u,device_tag:m});f&&(e.user_tag=f),e.events=[];let t=!1;g.some(n=>(t?t.session_key===n.session_key&&e.events.push(n):(t=n,e.events.push(n)),e.events.length<10));const n=encodeURIComponent((new Date).toISOString());P({url:`${i}/${l}/1/track?current_time=${n}`,method:"POST",body:e},(t,n,o)=>{let r=!0;var i;"status"===t?400===n?b("Bad request, please check parameters, error:",o):403===n?(b("Bad API Key, error:",o),s=!1):409===n||(r=!1,y++):t?(r=!1,y++):y=0,r&&(i=e.events,g=g.filter(e=>!i.some(t=>e.event_index===t.event_index)),E("dc.event_list",g),E("dc.next_index",h)),a=!1,g.length>0&&C(2e3*y)})}}function P(e,t){let n=!1;function o(...e){n||(n=!0,t(...e))}const r=e.method,i={Accept:"application/json"};let s=null;e.body instanceof FormData?s=e.body:e.body&&(s=JSON.stringify(e.body),i["Content-Type"]="text/plain");const a=Object.assign({},i,e.headers),c=e.url,d=new XMLHttpRequest;e.timeout&&(d.timeout=e.timeout),d.onload=()=>{const e=1223==d.status?204:d.status;let t=!1,n=null;t=d.response||d.responseText,e<200||e>599?n="wierd_status":e>=300&&(n="status"),o(n,e,t)},d.onerror=()=>{o("xhr_error")},d.ontimeout=()=>{o("timeout")},d.open(r,c,!0),U(a,(e,t)=>{Array.isArray(e)?e.forEach(e=>{d.setRequestHeader(t,e)}):d.setRequestHeader(t,e)}),d.send(s)}function F(){if(!arguments||0===arguments.length)throw new Error("log must have arguments");let e="";for(let t=0;t<arguments.length;t++){const n=arguments[t];if(t>0&&(e+=" "),R(n))e+=n.stack;else if("object"==typeof n)try{e+=JSON.stringify(n)}catch(t){e+=n}else e+=n}B({log_line:e})}const I=["repsonse_bytes","response_ms"],M={hostname:64,filename:256,log_level:64,device_tag:62,user_tag:62,remote_address:64,log_line:65535},q=H(I,Object.keys(M),["event_datetime"]);function B(e){if(!e||"object"!=typeof e)throw new Error("props must be an object.");e.event_datetime||(e.event_datetime=(new Date).toISOString()),U(M,(t,n)=>{if(n in e){const o=e[n],r=o&&o.toString();r?e[n]=r.slice(0,t):delete e[n]}}),I.forEach(t=>{if(t in e){let n=e[t];"number"!=typeof n&&(n=parseFloat(n)),isFinite(n)?e[t]=n:delete e[t]}});const t=X(e,q);return x.push(t),E("dc.log_list",x),J(),t}function R(e){return e&&e.stack&&e.message&&"string"==typeof e.stack&&"string"==typeof e.message}let L=!1,N=!1,$=0;function J(e=0){L||!s||N||(L=window.setTimeout(()=>{L=!1,V()},e))}function V(){if(s&&!N&&x.length>0){N=!0;const e=Object.assign({},v,{api_key:d,app_ver:u,device_tag:m});f&&(e.user_tag=f),e.events=x.slice(0,10);P({url:`${i}/${l}/1/app_log`,method:"POST",body:e},(t,n,o)=>{let r=!0;var i;"status"===t?400===n?b("Bad request, please check parameters, error:",o):403===n?b("Bad API Key, error:",o):409===n||(r=!1,$++):t?(r=!1,$++):$=0,r&&(i=e.events,x.splice(0,i.length),E("dc.log_list",x)),N=!1,x.length>0&&J(2e3*$)})}}function U(e,t){Object.keys(e).forEach(n=>{const o=e[n];t(o,n,e)})}function X(e,t){const n={};return t.forEach(t=>{t in e&&(n[t]=e[t])}),n}function H(){const e=[];for(let t=0;t<arguments.length;t++){const n=arguments[t];Array.prototype.push.apply(e,n)}return e}const K={init:function(e){i=e.base_url||k("dc.base_url",!1)||r,d=e.api_key,l=e.org_name,u=e.app_ver||"0",f=k("dc.user_tag",!1),e.errorLog&&"function"==typeof e.errorLog&&(O=e.errorLog),g=k("dc.event_list",[]),h=k("dc.next_index",0),g.forEach(e=>{e.event_index>=h&&(h=e.event_index+1)}),x=k("dc.log_list",[]),p=k("dc.last_dau_time",0),_=k("dc.has_sent_install",0)||Boolean(p),e.device_tag?(m=e.device_tag,E("dc.device_tag",e.device_tag)):m=function(){let e=k("dc.device_tag",!1);e||(e=j(),E("dc.device_tag",e));return e}(),w||(w=j()),_||(_=!0,E("dc.has_sent_install",!0),T({type:"install",kingdom:"organic",phylum:"organic",class:"organic",order:"organic",family:"organic",genus:"organic",species:"organic"})),A(),window.setInterval(A,432e5),function(){function e(e,t,n){let o=n;const r=e.match(t);return r&&r.length>1&&(o=r[1]),o}const t=navigator.userAgent;let n="unknown",o="unknown";-1!==t.indexOf("Win")?(n="windows",o=e(t,/Windows NT ([^ ;)]*)/,"unknown")):-1!==t.indexOf("iPhone OS")?(n="ios",o=e(t,/iPhone OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("iPad")?(n="ios",o=e(t,/CPU OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("Mac OS X")?(n="mac",o=e(t,/Mac OS X ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,"."),o=o.replace(/\.0$/,"")):-1!==t.indexOf("Android")?(n="android",o=e(t,/Android ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("X11")?n="unix":-1!==t.indexOf("Linux")&&(n="linux");let r="unknown",i="unknown";-1!==t.indexOf("Edge")?(r="edge",i=e(t,/Edge\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Chrome")?(r="chrome",i=e(t,/Chrome\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("CriOS")?(r="chrome",i=e(t,/CriOS\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Firefox")?(r="firefox",i=e(t,/Firefox\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Android")?(r="android",i=e(t,/Version\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Safari")?(r="safari",i=e(t,/Version\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Trident")?(r="ie",i=e(t,/rv:([^ ;)]*)/,"unknown")):-1!==t.indexOf("MSIE")?(r="ie",i=e(t,/MSIE ([^ ;)]*)/,"unknown")):(-1!==t.indexOf("MessengerForiOS")||-1!==t.indexOf("FB_IAB/MESSENGER"))&&(r="fbmessenger",i=e(t,/FBAV\/([^ ;)]*)/,"unknown"));let s="desktop";-1!==t.indexOf("iPod")?s="ipod":-1!==t.indexOf("iPhone")?s="iphone":-1!==t.indexOf("iPad")?s="ipad":-1!==t.indexOf("Android")?s=-1===t.indexOf("Mobile")?"android_tablet":"android":-1!==t.indexOf("Mobile")&&(s="mobile");v.os=n,v.os_ver=o,v.browser=r,v.browser_ver=i,v.device_type=s,v.device_family=s}(),s=!0,C(),e.add_error_handler&&window.addEventListener("error",S)},isReady:function(){return s},getDeviceTag:function(){return m},addUserTag:function(e){var t;f=e&&String(e),f?E("dc.user_tag",f):(t="dc.user_tag",delete window.localStorage[t])},event:function(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");return e.type="event",T(e)},economyEvent:function(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");if(!e.spend_currency)throw new Error("spend_currency is required");if("number"!=typeof e.spend_amount)throw new Error("spend_amount is required");return e.type="economy",T(e)},messageSendEvent:function(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");if(!e.from_tag)throw new Error("from_tag is required");if(!e.to_tag&&!e.to_list)throw new Error("to_tag or to_list is required");if(e.to_list&&!Array.isArray(e.to_list))throw new Error("to_list must be an array.");if(e.to_list||(e.to_list=[]),e.to_tag&&e.to_list.push(e.to_tag),0===e.to_list.length)throw new Error("must have at least 1 in to_list or a to_tag");return e.type="message_send",T(e)},log:F,logEvent:B,flush:function(){s?(c&&(window.clearTimeout(c),c=!1),L&&(window.clearTimeout(L),L=!1),g.length>0&&!a&&D(),x.length>0&&!N&&V()):b("DataCortex not ready. Call init() first.")}};return"undefined"!=typeof window&&(window.DataCortex=K),K});
//# sourceMappingURL=browser-data-cortex.min.js.map
