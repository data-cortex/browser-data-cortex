!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DataCortex={})}(this,function(e){"use strict";const t=["kingdom","phylum","class","order","family","genus","species","spend_currency","spend_type","network","channel"],n=["group_tag","from_tag"],o=["float1","float2","float3","float4","spend_amount"],r=E(t,n,o,["type","event_index","event_datetime","to_list"]),i="https://api.data-cortex.com";let s=i,a=!1,c=!1,d=null,l=!1,u=!1,f="0",g=!1,_=[],p=!1,m=0,w=!1,h=!1,y=0,v=0;const x={};let b=[],O=function(...e){console.error("Data Cortex Error:",...e)};function S(...e){O(...e)}function k(e,t){const n={};return t.forEach(t=>{t in e&&(n[t]=e[t])}),n}function E(...e){const t=[];for(let n=0;n<e.length;n++){const o=e[n];Array.prototype.push.apply(t,o)}return t}function T(e,t){let n;if(e in window.localStorage){const t=window.localStorage[e];try{n=JSON.parse(t)}catch(e){}}return void 0===n&&(n="function"==typeof t?t():t),n}function j(e,t){const n=JSON.stringify(t);window.localStorage[e]=n}function A(){let e="";const t=window.crypto||window.msCrypto;if(t&&t.getRandomValues){const n=new Uint32Array(8);t.getRandomValues(n);for(let t=0;t<n.length;t++)e+=n[t].toString(36)}else for(;e.length<32;)e+=Math.random().toString(36).slice(2);return e=e.slice(0,32),e}function C(e){s=e.base_url||T("dc.base_url",!1)||i,l=e.api_key,u=e.org_name,f=e.app_ver||"0",g=T("dc.user_tag",!1),e.errorLog&&"function"==typeof e.errorLog&&(O=e.errorLog),_=T("dc.event_list",[]),y=T("dc.next_index",0),_.forEach(e=>{e.event_index>=y&&(y=e.event_index+1)}),b=T("dc.log_list",[]),m=T("dc.last_dau_time",0),p=T("dc.has_sent_install",0)||Boolean(m),e.device_tag?(h=e.device_tag,j("dc.device_tag",e.device_tag)):h=function(){let e=T("dc.device_tag",!1);return e||(e=A(),j("dc.device_tag",e)),e}(),w||(w=A()),p||(p=!0,j("dc.has_sent_install",!0),R({type:"install",kingdom:"organic",phylum:"organic",class:"organic",order:"organic",family:"organic",genus:"organic",species:"organic"})),N(),window.setInterval(N,432e5),function(){function e(e,t,n){let o=n;const r=e.match(t);return r&&r.length>1&&(o=r[1]),o}const t=navigator.userAgent;let n="unknown",o="unknown";-1!==t.indexOf("Win")?(n="windows",o=e(t,/Windows NT ([^ ;)]*)/,"unknown")):-1!==t.indexOf("iPhone OS")?(n="ios",o=e(t,/iPhone OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("iPad")?(n="ios",o=e(t,/CPU OS ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("Mac OS X")?(n="mac",o=e(t,/Mac OS X ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,"."),o=o.replace(/\.0$/,"")):-1!==t.indexOf("Android")?(n="android",o=e(t,/Android ([^ ;)]*)/,"unknown"),o=o.replace(/_/g,".")):-1!==t.indexOf("X11")?n="unix":-1!==t.indexOf("Linux")&&(n="linux");let r="unknown",i="unknown";-1!==t.indexOf("Edge")?(r="edge",i=e(t,/Edge\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Chrome")?(r="chrome",i=e(t,/Chrome\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("CriOS")?(r="chrome",i=e(t,/CriOS\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Firefox")?(r="firefox",i=e(t,/Firefox\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Android")?(r="android",i=e(t,/Version\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Safari")?(r="safari",i=e(t,/Version\/([^ ;)]*)/,"unknown")):-1!==t.indexOf("Trident")?(r="ie",i=e(t,/rv:([^ ;)]*)/,"unknown")):-1!==t.indexOf("MSIE")?(r="ie",i=e(t,/MSIE ([^ ;)]*)/,"unknown")):(-1!==t.indexOf("MessengerForiOS")||-1!==t.indexOf("FB_IAB/MESSENGER"))&&(r="fbmessenger",i=e(t,/FBAV\/([^ ;)]*)/,"unknown"));let s="desktop";-1!==t.indexOf("iPod")?s="ipod":-1!==t.indexOf("iPhone")?s="iphone":-1!==t.indexOf("iPad")?s="ipad":-1!==t.indexOf("Android")?s=-1===t.indexOf("Mobile")?"android_tablet":"android":-1!==t.indexOf("Mobile")&&(s="mobile");x.os=n,x.os_ver=o,x.browser=r,x.browser_ver=i,x.device_type=s,x.device_family=s}(),a=!0,$(),e.add_error_handler&&window.addEventListener("error",D)}function D(e){e&&U("Javascript Error: message:",e.message,"error:",e.error)}function P(){return a}function F(){return h}function I(e){var t;g=!!e&&String(e),g?j("dc.user_tag",g):(t="dc.user_tag",delete window.localStorage[t])}function M(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");e.type="event",R(e)}function B(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");if(!e.spend_currency)throw new Error("spend_currency is required");if("number"!=typeof e.spend_amount)throw new Error("spend_amount is required");e.type="economy",R(e)}function q(e){if(!e||"object"!=typeof e)throw new Error("props must be an object");if(!e.from_tag)throw new Error("from_tag is required");if(!e.to_tag&&!e.to_list)throw new Error("to_tag or to_list is required");if(e.to_list&&!Array.isArray(e.to_list))throw new Error("to_list must be an array.");if(e.to_list||(e.to_list=[]),e.to_tag&&e.to_list.push(e.to_tag),0===e.to_list.length)throw new Error("must have at least 1 in to_list or a to_tag");e.type="message_send",R(e)}function N(){Date.now()-m>864e5&&(R({type:"dau"}),m=Date.now(),j("dc.last_dau_time",m))}function R(e){e.event_index=y++,e.event_datetime||(e.event_datetime=(new Date).toISOString()),w&&(e.group_tag=w),t.forEach(t=>{if(t in e){const n=e[t],o=n&&String(n);o?e[t]=o.slice(0,32):delete e[t]}}),n.forEach(t=>{if(t in e){const n=e[t],o=n&&String(n);o?e[t]=o.slice(0,64):delete e[t]}}),o.forEach(t=>{if(t in e){let n=e[t];"number"!=typeof n&&(n=parseFloat(n)),isFinite(n)?e[t]=n:delete e[t]}});const i=k(e,r);_.push(i),j("dc.event_list",_),$()}function $(e){d||!a||c||(d=window.setTimeout(()=>{d=null,J()},e||0))}function J(){if(a&&!c&&_.length>0){c=!0;const e=Object.assign({},x,{api_key:l,app_ver:f,device_tag:h});g&&(e.user_tag=g),e.events=[];let t=!1;_.some(n=>(t?t.session_key===n.session_key&&e.events.push(n):(t=n,e.events.push(n)),e.events.length<10));const n=encodeURIComponent((new Date).toISOString());L({url:`${s}/${u}/1/track?current_time=${n}`,method:"POST",body:e},(t,n,o)=>{let r=!0;var i;"status"===t?400===n?S("Bad request, please check parameters, error:",o):403===n?(S("Bad API Key, error:",o),a=!1):409===n||(r=!1,v++):t?(r=!1,v++):v=0,r&&(i=e.events,_=_.filter(e=>!i.some(t=>e.event_index===t.event_index)),j("dc.event_list",_),j("dc.next_index",y)),c=!1,_.length>0&&$(2e3*v)})}}function L(e,t){let n=!1;function o(...e){n||(n=!0,t(...e))}const r=e.method,i={Accept:"application/json"};let s=null;e.body instanceof FormData?s=e.body:e.body&&(s=JSON.stringify(e.body),i["Content-Type"]="text/plain");const a=Object.assign({},i,e.headers),c=e.url,d={method:r,headers:a};let l;if(s&&(d.body=s),e.timeout){const t=new AbortController;d.signal=t.signal,l=setTimeout(()=>{t.abort()},e.timeout)}fetch(c,d).then(async e=>{l&&clearTimeout(l);const t=e.status;let n="";try{n=await e.text()}catch(e){}let r=null;t<200||t>599?r="wierd_status":t>=300&&(r="status"),o(r,t,n)}).catch(e=>{l&&clearTimeout(l),"AbortError"===e.name?o("timeout"):o("fetch_error")})}function U(...e){if(!e||0===e.length)throw new Error("log must have arguments");let t="";for(let n=0;n<e.length;n++){const o=e[n];if(n>0&&(t+=" "),G(o))t+=o.stack;else if("object"==typeof o)try{t+=JSON.stringify(o)}catch(e){t+=o}else t+=o}W({log_line:t})}const V=["repsonse_bytes","response_ms"],X={hostname:64,filename:256,log_level:64,device_tag:62,user_tag:62,remote_address:64,log_line:65535},K=E(V,Object.keys(X),["event_datetime"]);function W(e){if(!e||"object"!=typeof e)throw new Error("props must be an object.");var t,n;e.event_datetime||(e.event_datetime=(new Date).toISOString()),t=X,n=(t,n)=>{if(n in e){const o=e[n],r=o&&o.toString();r?e[n]=r.slice(0,t):delete e[n]}},Object.keys(t).forEach(e=>{const o=t[e];n(o,e,t)}),V.forEach(t=>{if(t in e){let n=e[t];"number"!=typeof n&&(n=parseFloat(n)),isFinite(n)?e[t]=n:delete e[t]}});const o=k(e,K);b.push(o),j("dc.log_list",b),Y()}function G(e){return e&&e.stack&&e.message&&"string"==typeof e.stack&&"string"==typeof e.message}let z=null,H=!1,Q=0;function Y(e=0){z||!a||H||(z=window.setTimeout(()=>{z=null,Z()},e))}function Z(){if(a&&!H&&b.length>0){H=!0;const e=Object.assign({},x,{api_key:l,app_ver:f,device_tag:h});g&&(e.user_tag=g),e.events=b.slice(0,10);L({url:`${s}/${u}/1/app_log`,method:"POST",body:e},(t,n,o)=>{let r=!0;var i;"status"===t?400===n?S("Bad request, please check parameters, error:",o):403===n?S("Bad API Key, error:",o):409===n||(r=!1,Q++):t?(r=!1,Q++):Q=0,r&&(i=e.events,b.splice(0,i.length),j("dc.log_list",b)),H=!1,b.length>0&&Y(2e3*Q)})}}function ee(){a?(d&&(window.clearTimeout(d),d=null),z&&(window.clearTimeout(z),z=null),_.length>0&&!c&&J(),b.length>0&&!H&&Z()):S("DataCortex not ready. Call init() first.")}const te={init:C,isReady:P,getDeviceTag:F,addUserTag:I,event:M,economyEvent:B,messageSendEvent:q,log:U,logEvent:W,flush:ee};"undefined"!=typeof window&&(window.DataCortex=te),e.addUserTag=I,e.default=te,e.economyEvent=B,e.event=M,e.flush=ee,e.getDeviceTag=F,e.init=C,e.isReady=P,e.log=U,e.logEvent=W,e.messageSendEvent=q,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=browser-data-cortex.min.js.map
