!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e["browser-data-cortex"]=n()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=10,t=10,o=2e3,r=["kingdom","phylum","class","order","family","genus","species","group_tag","spend_currency","spend_type"],i=["float1","float2","float3","float4","spend_amount"],a=X(r,i,["type","event_index","event_datetime"]),s="https://api.data-cortex.com",d=s,c=!1,u=!1,f=!1,l=!1,p=!1,v="0",g=!1,m=[],y=0,_=!1,w=!1,h=0,x=0,b={},O=[];function S(){for(var e,n=arguments.length,t=Array(n),o=0;o<n;o++)t[o]=arguments[o];(e=console).error.apply(e,["Data Cortex Error:"].concat(t))}function k(e,n){var t=void 0;if(e in window.localStorage){var o=window.localStorage[e];try{t=JSON.parse(o)}catch(n){S("Failed to parse:",e,"json:",o)}}return void 0===t&&(t="function"==typeof n?n():n),t}function E(e,n){var t=JSON.stringify(n);window.localStorage[e]=t}function A(){var e="",n=window.crypto||window.msCrypto;if(n&&n.getRandomValues){var t=new Uint32Array(8);n.getRandomValues(t);for(var o=0;o<t.length;o++)e+=t[o].toString(36)}else for(;e.length<32;)e+=Math.random().toString(36).slice(2);return e=e.slice(0,32)}function j(){Date.now()-y>864e5&&(F({type:"dau"}),E("dc.last_dau_time",y=Date.now()))}function F(e){e.event_index=h++,e.event_datetime||(e.event_datetime=(new Date).toISOString()),_&&(e.group_tag=_),r.forEach(function(n){if(n in e){var t=e[n];t.toString().slice(0,32),e[n]=t}}),i.forEach(function(n){if(n in e){var t=e[n];"number"!=typeof t&&(t=parseFloat(t)),isFinite(t)?e[n]=t:delete e[t]}}),e=J(e,a),m.push(e),E("dc.event_list",m),T()}function T(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;f||!c||u||(f=window.setTimeout(function(){f=!1,function(){if(c&&!u&&m.length>0){u=!0;var e=Object.assign({},b,{api_key:l,app_ver:v,device_tag:w});g&&(e.user_tag=g),e.events=[];var t=!1;m.some(function(o){return t?t.session_key==o.session_key&&e.events.push(o):(t=o,e.events.push(o)),e.events.length<n});var r=encodeURIComponent((new Date).toISOString()),i=d+"/"+p+"/1/track?current_time="+r,a={url:i,method:"POST",body:e};I(a,function(n,t,r){var i,a=!0;"status"==n?400==t?S("Bad request, please check parameters, error:",r):403==t?(S("Bad API Key, error:",r),c=!1):409==t||(a=!1,x++):n?(a=!1,x++):x=0,a&&(i=e.events,E("dc.event_list",m=m.filter(function(e){return!i.some(function(n){return e.event_index==n.event_index})})),E("dc.next_index",h)),u=!1,m.length>0&&T(x*o)})}}()},e))}function I(e,n){function t(){n.apply(void 0,arguments),n=function(){}}var o=e.method,r={Accept:"application/json"},i=null;e.body instanceof FormData?i=e.body:e.body&&(i=JSON.stringify(e.body),r["Content-Type"]="text/plain");var a=Object.assign({},r,e.headers),s=e.url,d=new XMLHttpRequest;e.timeout&&(d.timeout=e.timeout),d.onload=function(){var e,n=1223===d.status?204:d.status,o=null;e=d.response||d.responseText,n<100||n>599?o=new TypeError("Network request failed"):n>399&&(o="status"),t(o,n,e)},d.onerror=function(){t(new TypeError("Network request failed"))},d.ontimeout=function(){t("timeout")},d.open(o,s,!0),V(a,function(e,n){Array.isArray(e)||(e=[e]),e.forEach(function(e){d.setRequestHeader(n,e)})}),d.send(i)}var M=["repsonse_bytes","response_ms"],C={hostname:64,filename:256,log_level:64,device_tag:62,user_tag:62,remote_address:64,log_line:65535},P=X(M,Object.keys(C),["event_datetime"]);function q(n){if(!n||"object"!==(void 0===n?"undefined":e(n)))throw new Error("props must be an object.");n.event_datetime||(n.event_datetime=(new Date).toISOString()),V(C,function(e,t){if(t in n){var o=n[t];o.toString().slice(0,e),n[t]=o}}),M.forEach(function(e){if(e in n){var t=n[e];"number"!=typeof t&&(t=parseFloat(t)),isFinite(t)?n[e]=t:delete n[t]}}),n=J(n,P),O.push(n),E("dc.log_list",O),R()}var B=!1,D=!1,N=0;function R(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;B||!c||D||(B=window.setTimeout(function(){B=!1,function(){if(c&&!D&&O.length>0){D=!0;var e=Object.assign({},b,{api_key:l,app_ver:v,device_tag:w});g&&(e.user_tag=g),e.events=O.slice(0,t);var n=d+"/"+p+"/1/app_log",r={url:n,method:"POST",body:e};I(r,function(n,t,r){var i,a=!0;"status"==n?400==t?S("Bad request, please check parameters, error:",r):403==t?S("Bad API Key, error:",r):409==t||(a=!1,N++):n?(a=!1,N++):N=0,a&&(i=e.events,O.splice(0,i.length),E("dc.log_list",O)),D=!1,O.length>0&&R(N*o)})}}()},e))}function V(e,n){Object.keys(e).forEach(function(t){var o=e[t];n(o,t,e)})}function J(e,n){var t={};return n.forEach(function(n){n in e&&(t[n]=e[n])}),t}function X(){for(var e=[],n=0;n<arguments.length;n++){var t=arguments[n];Array.prototype.push.apply(e,t)}return e}var U={init:function(e,n){n||(n=function(){}),d=e.base_url||k("dc.base_url",!1)||s,l=e.api_key,p=e.org_name,v=e.app_ver||"0",g=k("dc.user_tag",!1),m=k("dc.event_list",[]),h=k("dc.next_index",0),m.forEach(function(e){e.event_index>=h&&(h=e.event_index+1)}),O=k("dc.log_list",[]),y=k("dc.last_dau_time",0),t=k("dc.device_tag",!1),t||(E("dc.device_tag",t=A()),F({type:"install",kingdom:"organic",phylum:"organic",class:"organic",order:"organic",family:"organic",genus:"organic",species:"organic"})),w=t,_||(_=A()),j(),window.setInterval(j,432e5),function(){function e(e,n,t){var o=t,r=e.match(n);return r&&r.length>1&&(o=r[1]),o}var n=navigator.userAgent,t="unknown",o="unknown";-1!=n.indexOf("Win")?(t="windows",o=e(n,/Windows NT ([^ ;)]*)/,"unknown")):-1!=n.indexOf("iPhone OS")?(t="ios",o=(o=e(n,/iPhone OS ([^ ;)]*)/,"unknown")).replace(/_/g,".")):-1!=n.indexOf("Mac OS X")?(t="mac",o=(o=(o=e(n,/Mac OS X ([^ ;)]*)/,"unknown")).replace(/_/g,".")).replace(/\.0$/,"")):-1!=n.indexOf("Android")?(t="android",o=(o=e(n,/Android ([^ ;)]*)/,"unknown")).replace(/_/g,".")):-1!=n.indexOf("X11")?t="unix":-1!=n.indexOf("Linux")&&(t="linux");var r="unknown",i="unknown";-1!==n.indexOf("Edge")?(r="edge",i=e(n,/Edge\/([^ ;)]*)/,"unknown")):-1!==n.indexOf("Chrome")?(r="chrome",i=e(n,/Chrome\/([^ ;)]*)/,"unknown")):-1!==n.indexOf("CriOS")?(r="chrome",i=e(n,/CriOS\/([^ ;)]*)/,"unknown")):-1!==n.indexOf("Firefox")?(r="firefox",i=e(n,/Firefox\/([^ ;)]*)/,"unknown")):-1!==n.indexOf("Android")?(r="android",i=e(n,/Version\/([^ ;)]*)/,"unknown")):-1!==n.indexOf("Safari")?(r="safari",i=e(n,/Version\/([^ ;)]*)/,"unknown")):-1!==n.indexOf("Trident")?(r="ie",i=e(n,/rv:([^ ;)]*)/,"unknown")):-1!==n.indexOf("MSIE")?(r="ie",i=e(n,/MSIE ([^ ;)]*)/,"unknown")):-1!==n.indexOf("MessengerForiOS")?(r="fbmessenger",i=e(n,/FBAV\/([^ ;)]*)/,"unknown")):-1!==n.indexOf("FB_IAB/MESSENGER")&&(r="fbmessenger",i=e(n,/FBAV\/([^ ;)]*)/,"unknown"));var a="desktop";-1!=n.indexOf("iPod")?a="ipod":-1!=n.indexOf("iPhone")?a="iphone":-1!=n.indexOf("iPad")?a="ipad":-1!=n.indexOf("Android")?a=-1!=n.indexOf("Mobile")?"android":"android_tablet":-1!=n.indexOf("Mobile")&&(a="mobile"),b.os=t,b.os_ver=o,b.browser=r,b.browser_ver=i,b.device_type=a,b.device_family=a}(),c=!0,T(),n();var t},isReady:function(){return c},addUserTag:function(e){e&&"string"!=typeof e&&(e=e.toString()),E("dc.user_tag",g=e)},event:function(n){if(!n||"object"!==(void 0===n?"undefined":e(n)))throw new Error("props must be an object");n.type="event",F(n)},economyEvent:function(n){if(!n||"object"!=(void 0===n?"undefined":e(n)))throw new Error("props must be an object");if(!n.spend_currency)throw new Error("spend_currency is required");if("number"!=typeof n.spend_amount)throw new Error("spend_amount is required");n.type="economy",F(n)},log:function(){if(!arguments||0==arguments.length)throw new Error("log must have arguments");for(var n,t="",o=0;o<arguments.length;o++){var r=arguments[o];if(o>0&&(t+=" "),(n=r)&&n.stack&&n.message&&"string"==typeof n.stack&&"string"==typeof n.message)t+=r.stack;else if("object"==(void 0===r?"undefined":e(r)))try{t+=JSON.stringify(r)}catch(n){t+=r}else t+=r}q({log_line:t})},logEvent:q};return window.DataCortex=U,U});
